# QNX-Linux 胶水代码生成系统 v2.0 架构设计

## 系统概览

基于RAG + MCP + Agent的智能胶水代码生成系统，用于QNX到Linux的函数迁移。

## 核心组件

### 1. QNX文档RAG系统
- **技术栈**: LlamaIndex + Chroma
- **功能**: QNX HTML技术文档向量化存储和语义检索
- **输入**: QNX官方文档HTML文件
- **输出**: 结构化函数信息(函数签名、参数、返回值、用法)

### 2. MCP服务层

#### 2.1 Linux函数信息MCP (`linux_func_mcp`)
- **功能**: 提供musl libc函数实现信息
- **工具**:
  - `get_linux_function`: 根据函数名获取实现代码和参数信息
  - `search_similar_functions`: 搜索相似功能的函数
  - `analyze_dependencies`: 分析函数依赖关系

#### 2.2 QNX函数信息MCP (`qnx_func_mcp`)
- **功能**: 基于RAG提供QNX函数信息
- **工具**:
  - `get_qnx_function`: 根据函数名从RAG检索函数信息
  - `semantic_search`: 语义搜索相关函数
  - `get_function_docs`: 获取详细文档说明

#### 2.3 编译验证MCP (`compile_mcp`)
- **功能**: 代码编译验证和错误反馈
- **工具**:
  - `compile_code`: 编译生成的胶水代码
  - `analyze_errors`: 分析编译错误
  - `suggest_fixes`: 基于错误信息提供修复建议

#### 2.4 IDA分析MCP (`ida_mcp`) 
- **功能**: 二进制代码分析支持
- **工具**:
  - `analyze_function`: 分析函数二进制实现
  - `find_missing_symbols`: 查找缺失的符号定义
  - `extract_constants`: 提取关键常量和结构体

### 3. 智能生成Agent

#### 3.1 核心逻辑
```
输入: 目标函数名
↓
1. 获取QNX函数信息 (qnx_func_mcp)
2. 获取Linux对应实现 (linux_func_mcp) 
3. 函数兼容性分析
4. 选择生成策略:
   - 直接迁移: 参数兼容，直接封装
   - 适配生成: 参数需要转换
   - 启发式实现: musl缺失函数，生成占位实现
   - IDA辅助: 复杂函数需要二进制分析
5. 代码生成 (Claude 4 Sonnet)
6. 编译验证 (compile_mcp)
7. 错误修复循环
↓
输出: 验证通过的胶水代码
```

#### 3.2 生成策略

**策略1: 直接迁移**
- 条件: 函数签名兼容，musl有对应实现
- 操作: 生成简单的封装函数

**策略2: 参数适配**  
- 条件: 函数存在但参数不兼容
- 操作: 生成参数转换代码

**策略3: 启发式实现**
- 条件: musl缺失该函数
- 操作: 基于函数语义生成合理的占位实现
- 例如: `uint64_t __stackavail(void) { return 0xffffffffffffffff; }`

**策略4: IDA辅助分析**
- 条件: 复杂函数需要了解底层实现
- 操作: 使用IDA MCP分析二进制，指导生成

## 工作流程

1. **初始化**: 加载QNX文档到RAG系统
2. **函数查询**: 接收目标函数名列表
3. **信息收集**: 并行调用MCP服务收集函数信息
4. **智能分析**: Agent分析兼容性和选择策略
5. **代码生成**: 基于策略生成胶水代码
6. **编译验证**: 验证代码正确性
7. **迭代优化**: 基于编译错误反馈优化
8. **输出交付**: 生成最终的胶水代码文件

## 优势

1. **智能化**: RAG语义检索 + LLM推理
2. **模块化**: MCP标准化接口，易于扩展
3. **可靠性**: 编译验证确保代码质量
4. **灵活性**: 多种生成策略适应不同场景
5. **可维护**: 清晰的架构分层