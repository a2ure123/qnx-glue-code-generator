
<!DOCTYPE html
  PUBLIC "" "about:legacy-compat">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />        
      <meta name="copyright" content="(C) Copyright 2005" /><meta name="DC.rights.owner" content="(C) Copyright 2005" /><meta name="DC.Type" content="reference" /><meta name="DC.Title" content="cache_init()" /><meta name="abstract" content="Register with the cache-coherency library" /><meta name="description" content="Register with the cache-coherency library" /><meta name="indexterms" content="cache_init()" /><meta name="DC.Relation" scheme="URI" content="../../../com.qnx.doc.neutrino.lib_ref/topic/lib-c.html" /><meta name="DC.Relation" scheme="URI" content="../../../com.qnx.doc.neutrino.lib_ref/topic/c/cache_fini.html" /><meta name="DC.Relation" scheme="URI" content="../../../com.qnx.doc.neutrino.lib_ref/topic/c/cache_flush.html" /><meta name="DC.Relation" scheme="URI" content="../../../com.qnx.doc.neutrino.lib_ref/topic/c/cache_inval.html" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="cache_init" /><meta name="DC.Language" content="en-us" /><link rel="stylesheet" type="text/css" href="../../../oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>cache_init()</title><link rel="canonical" type="html" href="https://www.qnx.com/developers/docs/7.1/#com.qnx.doc.neutrino.lib_ref/" /><!--  Generated with Oxygen version 18.1, build number 2017020917.  --><link rel="stylesheet" type="text/css" href="../../../oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="../../../oxygen-webhelp/resources/skins/skin.css" /><script type="text/javascript"><!--
            
            var prefix = "../../../index.html";
            
            --></script><script type="text/javascript" src="../../../oxygen-webhelp/resources/js/jquery-1.11.3.min.js"><!----></script><script type="text/javascript" src="../../../oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="../../../oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="../../../oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="../../../oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script><script type="text/javascript"> var _gaq = _gaq || [];  _gaq.push(['_setAccount', 'UA-27400275-1']); _gaq.push(['_setDomainName', 'www.qnx.com']);_gaq.push(['_setAllowLinker', true]);_gaq.push(['_trackPageview']);(function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);})();</script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="cache_init">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><button onClick="window.print()" title="Print this page" aria-label="Print this page"></button></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td style="width:75%;"><span class="topic_breadcrumb_links"><span class="topic_breadcrumb_link"><a class="navheader_parent_path" href="../../../com.qnx.doc.neutrino.lib_ref/topic/lib-c.html" title="C">C</a></span></span></td><td><span id="topic_navigation_links" class="navheader">
<span class="navparent"><a class="link" href="../../../com.qnx.doc.neutrino.lib_ref/topic/lib-c.html" title="C"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">C</span></a></span>  </span></td></tr></tbody></table>


<h1 class="title topictitle1"><span class="keyword apiname">cache_init()</span></h1>
<table width="100%"><tbody><tr><td align="left"><button style="margin:3px 5px; background-color:default; border:default; pointer-events: none; font-size:0.9em;">QNX SDP</button><button style="margin:3px 5px; background-color:default; border:default; pointer-events: none; font-size:0.9em;">7.1</button><button style="margin:3px 5px; background-color:default; border:default; pointer-events: none; font-size:0.9em;">C Library Reference</button><button style="margin:3px 5px; background-color:default; border:default; pointer-events: none; font-size:0.9em;">API</button><button style="margin:3px 5px; background-color:default; border:default; pointer-events: none; font-size:0.9em;">Developer</button></td><td align="right"><span style="margin:0px 5px; font-size:0.9em;">Updated: October 28, 2024</span></td></tr></tbody></table>



<div class="body refbody"><p class="shortdesc"><em class="ph i">Register with the cache-coherency library</em></p>


<div class="section">
<p class="p">


</p>

</div>


<div class="section refsyn"><h2 class="title sectiontitle">Synopsis:</h2>

<pre class="pre codeblock">
#include &lt;sys/cache.h&gt;

int cache_init(int <var class="keyword varname">flags</var>, 
               struct cache_ctrl *<var class="keyword varname">cinfo</var>, 
               const char *<var class="keyword varname">dllname</var>);
</pre>

</div>



<div class="section"><h2 class="title sectiontitle">Arguments:</h2>


<dl class="dl">

<dt class="dt dlterm"><var class="keyword varname">flags</var></dt>

<dd class="dd">Zero, or flags that control the behavior of the cache-coherency library.
  The only flag currently defined is:

  <ul class="ul">
  <li class="li"><span class="keyword const">CACHE_INIT_FLAG_IGNORE_SCAN</span> â specify that memory accesses to and from the
    device aren't snooped,  whether or not the data caches in the system are reported as snooping or not.
    This might be required for devices in the system that  bypass the bus-snooping mechanism, or as a workaround
    for hardware bugs.
    
  </li>


  </ul>

</dd>




<dt class="dt dlterm"><var class="keyword varname">cinfo</var></dt>

<dd class="dd">A pointer to a <span class="keyword dtype">cache_ctrl</span> structure that contains state information.
  The library uses this structure to store various information that uses when
  performing synchronization operations.
  The driver should allocate and initialize this structure.
  All of the members of the structure should be initialized with zeros, with the exception of the
  <var class="keyword varname">fd</var> field.
  For more information regarding the members of this structure, see the description section. 
</dd>




<dt class="dt dlterm"><var class="keyword varname">dllname</var></dt>

<dd class="dd">The path of a DLL to load that provides cache-synchronization routines,
  or <span class="keyword const">NULL</span> to use the library specified by the <span class="keyword envar">LIBCACHE_DLL_PATH</span>
  environment variable.
  
  
</dd>



</dl>


</div>



<div class="section"><h2 class="title sectiontitle">Library:</h2>


<p class="p"><span class="ph filepath">libcache</span></p>

<p class="p">Use the <span class="keyword option">-l cache</span> option to
<a class="xref" href="../../../com.qnx.doc.neutrino.utilities/topic/q/qcc.html"><span class="keyword cmdname">qcc</span></a>
to link against this library.</p>

</div>



<div class="section"><h2 class="title sectiontitle">Description:</h2>


<p class="p">
The <span class="keyword apiname">cache_init()</span> function initializes the cache coherency
library (<span class="ph filepath">libcache</span>). Your driver must call
<span class="keyword apiname">cache_init()</span> before using the library.  
</p>


<div class="note note"><span class="notetitle">Note:</span> 
This function was added in QNX Momentics 6.3.0 SP2.
</div>


<p class="p"><strong class="ph b">Members of the <span class="keyword dtype">cache_ctrl</span> structure</strong></p>


<p class="p">
The <span class="keyword dtype">cache_ctrl</span> structure includes at least the following members:
</p>


<dl class="dl">

<dt class="dt dlterm"><var class="keyword varname">cache_line_size</var></dt>

<dd class="dd">When this function returns, this field will specify the size, in bytes, of a cache line's worth of data.
  If the system implements a bus-snooping protocol, this field may contain zero.
</dd>




<dt class="dt dlterm"><var class="keyword varname">cache_flush_rate</var></dt>

<dd class="dd">Provides a runtime indication to the driver, of the cost of flushing the cache:

  <dl class="dl">
  
  <dt class="dt dlterm"><span class="keyword const">CACHE_OP_RATE_SNOOP</span></dt>

  <dd class="dd">Due to a bus-snooping mechanism, a cache flush operation has negligible cost.
    
  </dd>

  

  
  <dt class="dt dlterm"><span class="keyword const">CACHE_OP_RATE_INLINE</span></dt>

  <dd class="dd">Cache flush operations are implemented with CPU-specific inline routines, and are inexpensive.
    
  </dd>

  

  
  <dt class="dt dlterm"><span class="keyword const">CACHE_OP_RATE_CALLOUT</span></dt>

  <dd class="dd">Cache flush operations are implemented by calling an external function, which incurs a small CPU overhead.
    
  </dd>

  

  
  <dt class="dt dlterm"><span class="keyword const">CACHE_OP_RATE_MSYNC</span></dt>


  <dd class="dd">Cache flush operations are implemented by calling
    <a class="xref" href="../m/msync.html" title="Synchronize memory with physical storage"><span class="keyword apiname">msync()</span></a>.
    Since this function is implemented with a system call, the operation will be very expensive.
    It is very unlikely that the library will end up calling <span class="keyword apiname">msync()</span>, but
    in the event that it does, the driver could potentially achieve better performance by mapping data
    buffers as noncacheable, so that it can avoid having to perform cache synchronization operations.
    
  </dd>

  

  </dl>

</dd>




<dt class="dt dlterm"><var class="keyword varname">cache_invalidate_rate</var></dt>

<dd class="dd">Provides a runtime indication to the driver of the cost of invalidating the cache.
  The defined values for this field are similar to those defined for the
  <var class="keyword varname">cache_flush_rate</var> field.
</dd>




<dt class="dt dlterm"><var class="keyword varname">fd</var></dt>

<dd class="dd">The driver should set this field to <span class="keyword const">NOFD</span>.</dd>



</dl>


<p class="p">
Don't reference or modify the other fields in the structure.
</p>


<p class="p"><strong class="ph b">Cache coherency</strong></p>


<p class="p">


Device drivers for hardware that performs Direct Memory Access (DMA) use this 
cache coherency library. These  devices  are either bus-mastering devices that can directly read or modify
memory, or devices that use a DMA controller to transfer data
between the device and memory.  The key factor is that memory may be   
accessed by an agent other than the CPU(s).
</p>


<p class="p">
On some systems, cache coherency is performed by a bus-snooping 
protocol that is implemented in hardware.
In such systems, the CPU(s) snoop all transactions on the memory
bus and automatically keep their caches in sync with the memory.
</p>


<p class="p">
For example, if an external agent modifies data at a given memory
location, the CPU will observe the memory write cycle, and if it
has a cached copy of the data at that memory location, it will
invalidate the corresponding cache entry.  The next time the CPU
tries to examine the memory location, it will fetch the modified
data from memory, instead of retrieving stale data from the cache.
</p>


<p class="p">
Similarly, special action is taken if an external
agent attempts to read a memory location, and a CPU has modified
the memory location, but the modified copy of the data is in its
cache, and hasn't yet been written to memory.  In this case, the
read cycle is suspended while the CPU copies the updated
version of the data out to memory.  Once memory has been updated
with the modified version, the read cycle can continue, and the
external agent  gets the updated copy of the data.
</p>


<p class="p">
On other systems, where there is no such snooping protocol
implemented in hardware, cache coherency between the CPU and
external devices must be maintained by driver software.  These are
typically single-CPU systems, since on SMP systems, bus-snooping
is the usual mechanism of keeping the CPUs in sync with each other.
To work on these systems, special action needs to be taken by driver
software, to ensure data coherency between the CPU and external
devices.
</p>


<p class="p">
A driver ensures data coherency for systems that don't have a bus-snooping
protocol in different ways. The first one 
is the <span class="q">&#147;big hammer&#148;</span> approach that simply disables caching 
for any memory location that can be accessed by both the CPU and 
the external device. This approach, however, has a severe performance
penalty; for some network devices on certain systems, the throughput reduces
to roughly half of the original value.
</p>


<p class="p">
You can solve the above throughput problem by using cacheable data buffers, 
but perform synchronization operations on the data buffers at strategic points
in the driver.  For example, in the case of packet transmission
for a network device, the driver must ensure that any
data pertaining to the packet had been flushed out to memory, before
allowing the DMA agent to begin copying the data.  In the case of
packet reception, the driver should invalidate any cached data
pertaining to the packet buffer, before letting the DMA agent
transfer data into the receive buffer.  This eliminates the
possibility that the CPU could write a cached portion of the data
out to the memory buffer, after the network device had updated the
buffer with new packet data.
</p>


<p class="p">
The driver can perform cache flushing and invalidation operations
in one of two ways.  It can issue special CPU-dependent instructions that 
operate on the cache, or it can use the cache-coherency
library (<span class="ph filepath">libcache</span>).  The latter approach is preferable, since
it makes your driver  portable. The library performs the
correct thing based on the type of CPU it's running on.  For
maximum portability, the library must be used whether the system has
a bus-snooping protocol or not.  If the system implements a
bus-snooping protocol, the library determines this, and ensures
that there are no unnecessary synchronization operations being
performed.
</p>


</div>



<div class="section"><h2 class="title sectiontitle">Returns:</h2>


<dl class="dl" compact="compact">

<dt class="dt dlterm">0</dt>

<dd class="dd">Success.</dd>




<dt class="dt dlterm">-1</dt>

<dd class="dd">Failure; <a class="xref" href="../e/errno.html" title="Thread-local error variable"><var class="keyword varname">errno</var></a> is set.
  If this function fails, it isn't safe for devices to DMA to or from cacheable buffers.
  Additionally, calling other functions with the <span class="keyword dtype">cache_ctrl</span> structure
  that was provided will have unpredictable results.
</dd>



</dl>


</div>



<div class="section"><h2 class="title sectiontitle">Classification:</h2>

<p class="p"><a class="xref" href="../summary.html#summary__CLASSIFICATION">QNX Neutrino</a></p>



<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all">
<thead class="thead" align="left">
<tr><th class="entry" valign="top" id="d1264264e400">Safety:</th>
<th class="entry" valign="top" id="d1264264e402">Â </th>
</tr>

</thead>

<tbody class="tbody">
<tr><td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Cancellation point</td>
<td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Yes</td>
</tr>

<tr><td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Interrupt handler</td>
<td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">No</td>
</tr>

<tr><td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Signal handler</td>
<td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Yes</td>
</tr>

<tr><td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Thread</td>
<td class="entry" valign="top" headers="d1264264e400 d1264264e402 ">Yes</td>
</tr>

</tbody>

</table>
</div>


</div>


<div class="section"><h2 class="title sectiontitle">Caveats:</h2>


<p class="p">
The cache-invalidation operation could have certain
negative side effects, which the driver must take measures to avoid.
If a data buffer partially shares a cache line with some other
piece of data (including another data buffer), data corruption
could occur.  Since the invalidation is performed with cache-line
granularity, invalidating data at the start or end of the buffer
could potentially invalidate important data, such as program
variables, which means that changes made to the data by the CPU
could be inadvertently lost.
</p>


<p class="p">
You can avoid this by padding the data buffers.  The driver should
pad the start of the buffer, so that it starts on the next cache
line boundary.  It should also pad the buffer out to the end of the
last cache line of the buffer.  To do this, the driver can use the
<var class="keyword varname">cache_line_size</var> field of the <span class="keyword dtype">cache_ctrl</span> structure.  
Note that this value could be zero (e.g., if there is a cache-coherency protocol
implemented in hardware), in which case the driver doesn't need to do any padding.
</p>

</div>


</div>





<div class="related-links"><div class="relinfo relref"><strong>Related reference</strong><br />
<div class="related_link"><a class="navheader_parent_path" href="../../../com.qnx.doc.neutrino.lib_ref/topic/c/cache_fini.html" title="Free cache-coherency resources when the driver is unloaded">cache_fini()</a></div>
<div class="related_link"><a class="navheader_parent_path" href="../../../com.qnx.doc.neutrino.lib_ref/topic/c/cache_flush.html" title="Flush cache lines associated with a data buffer">CACHE_FLUSH()</a></div>
<div class="related_link"><a class="navheader_parent_path" href="../../../com.qnx.doc.neutrino.lib_ref/topic/c/cache_inval.html" title="Invalidate cache lines associated with a data buffer">CACHE_INVAL()</a></div>
</div>
</div><div class="navfooter"><!---->
<span class="navparent"><a class="link" href="../../../com.qnx.doc.neutrino.lib_ref/topic/lib-c.html" title="C"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">C</span></a></span>  </div>
</body>
</html>